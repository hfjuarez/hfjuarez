---
import Desktop from '@/components/Desktop';
import aboutRaw from '@/data/about.md?raw';
import stack from '@/data/stack.json';
import rawDock from '@/data/dock.json';
import meData from '@/data/me.json';
import '@/styles/tailwind.css';
import '@/styles/globals.scss';

const me = {
	...meData,
	personal: {
		...meData.personal,
		age: Math.abs(
			new Date(Date.now() - new Date(meData.personal.dob).getTime()).getUTCFullYear() - 1970
		),
	},
	professional: {
		...meData.professional,
		yearsOfExperience: Math.floor(
			(Date.now() - new Date(meData.professional.startDate).getTime()) /
				(1000 * 60 * 60 * 24 * 365)
		),
	},
};

const projectFiles = import.meta.glob('../content/projects/*.md', { eager: true }) as Record<
	string,
	{ frontmatter: { name: string; url: string; stack: string[] }; compiledContent: () => Promise<string> }
>;

const dock = rawDock.map((app) =>
	app.id === 'contact' ? { ...app, url: `mailto:${meData.contact.email}` } : app
);

const projects = await Promise.all(
	Object.entries(projectFiles)
		.sort(([a], [b]) => a.localeCompare(b))
		.map(async ([path, mod]) => ({
			id: path.split('/').pop()!.replace('.md', ''),
			name: mod.frontmatter.name,
			url: mod.frontmatter.url,
			stack: mod.frontmatter.stack ?? [],
			content: await mod.compiledContent(),
		}))
);
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content={`${me.personal.name} ${me.personal.lastName} â€” Software Engineer`} />
		<title>{me.personal.name} {me.personal.lastName}</title>
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap"
			rel="stylesheet"
		/>
	</head>
	<body>
		<div id="astro-root">
			<Desktop
				client:load
				aboutContent={aboutRaw}
				projects={projects}
				stack={stack}
				dock={dock}
				me={me}
			/>
		</div>
	</body>
</html>
